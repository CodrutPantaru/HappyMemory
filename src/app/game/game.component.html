<div class="game-shell">
  <header class="top-bar">
    <a
      class="nav-icon"
      routerLink="/"
      [attr.aria-label]="i18n.t('game.back')"
      (click)="onBack()"
      >
      ‚Üê
    </a>
    <div class="nav-title">{{ selectedCategoryLabel || i18n.t('game.chooseCategory') }}</div>
    <div class="nav-actions">
      @if (stage === 'play') {
        <div class="header-time">{{ i18n.t('game.time') }}: {{ formattedElapsed }}</div>
      }
      <button
        class="nav-icon"
        type="button"
        [class.is-off]="!soundOn"
        [attr.aria-pressed]="soundOn"
        [attr.aria-label]="i18n.t('settings.sound')"
        (click)="toggleSound()"
        >
        üîä
      </button>
      <button
        class="nav-icon"
        type="button"
        [class.is-off]="!musicOn"
        [attr.aria-pressed]="musicOn"
        [attr.aria-label]="i18n.t('settings.music')"
        (click)="toggleMusic()"
        >
        üéµ
      </button>
    </div>
  </header>

  <main class="page-content" [class.is-play]="stage === 'play'">
  @if (stage === 'select') {
    <section class="select">
      <div class="select-card">
        <div class="select-title">{{ i18n.t('game.chooseCategory') }}</div>
        <div class="choice-grid">
          @for (category of categories; track category) {
            <button
              class="choice-card"
              [class.locked]="!isCategoryUnlocked(category.id)"
              [disabled]="!isCategoryUnlocked(category.id)"
              (click)="selectCategory(category.id)"
              >
              <div class="choice-emoji">{{ category.emoji }}</div>
              <div class="choice-text">{{ i18n.t(category.labelKey) }}</div>
              @if (!isCategoryUnlocked(category.id)) {
                <div class="choice-lock">üîí {{ categoryPrice(category.id) }}</div>
              }
            </button>
          }
        </div>
      </div>
        <div class="select-card">
          <div class="select-title">{{ i18n.t('settings.matchSize') }}</div>
          <div class="choice-grid">
            @for (size of matchSizes; track size) {
              <button
                class="choice-card small"
                [class.active]="selectedMatchSize === size"
                (click)="setMatchSize(size)"
                >
                <div class="choice-text">{{ i18n.t('settings.matchCount', { count: size }) }}</div>
              </button>
            }
          </div>
        </div>
        <div class="select-card">
          <div class="select-title">{{ i18n.t('settings.grid') }}</div>
          <div class="choice-grid">
            @for (option of gridOptions; track option) {
              <button
                class="choice-card small"
                [class.active]="selectedGridId === option.id"
                (click)="setGrid(option.id)"
                >
                <div class="choice-text">{{ option.label }}</div>
              </button>
            }
          </div>
        </div>
      </section>
    }

    @if (stage === 'play') {
      <section class="game">
        <div class="board-wrapper">
          <div
            class="board"
            [style.gridTemplateColumns]="gridTemplate"
            [style.--cols]="currentOption.cols"
            [style.--rows]="currentOption.rows"
            >
            @for (card of cards; track trackCard($index, card)) {
              <app-card
                [card]="card"
                [backImageUrl]="backCardUrl"
                [disabled]="lockBoard"
                (reveal)="reveal($event)"
              ></app-card>
            }
          </div>
        </div>
      </section>
    }
  </main>

  <footer class="bottom-footer" aria-hidden="true"></footer>
  <div class="ad-container" aria-hidden="true"></div>

  @if (isWin) {
    <div class="win-overlay">
      <div class="confetti-layer">
        @for (piece of confettiPieces; track piece) {
          <span
            class="confetti"
            [style.left.%]="piece.left"
            [style.width.px]="piece.size"
            [style.height.px]="piece.size * 1.6"
            [style.background]="'hsl(' + piece.hue + ', 85%, 60%)'"
            [style.animation-delay.s]="piece.delay"
            [style.animation-duration.s]="piece.duration"
            [style.transform]="'rotate(' + piece.rotate + 'deg)'"
          ></span>
        }
      </div>
      <div class="win-card">
        <div class="win-title">{{ i18n.t('game.winTitle') }} üéâ</div>
        <p>{{ i18n.t('game.winText', { moves }) }}</p>
        <p>{{ i18n.t('game.time') }}: {{ formattedElapsed }}</p>
        <div class="win-actions">
          <button class="ghost" type="button" (click)="goHomeFromWin()">{{ i18n.t('game.back') }}</button>
          <button class="ghost" type="button" (click)="playAgain()">{{ i18n.t('game.playAgain') }}</button>
          <button class="primary" type="button" (click)="closeWinModal()">{{ i18n.t('game.thanks') }}</button>
        </div>
      </div>
    </div>
  }
</div>
